<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Headline Game</title>
  <style>
    :root { --neon:#0ff; --bg:#111; --card:#1b1b1b; --text:#eee; --muted:#aaa; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, Arial, sans-serif; background:var(--bg); color:var(--text);
           max-width:720px; margin:2rem auto; padding:0 1rem; }
    h1 { text-align:center; color:var(--neon); text-shadow:0 0 8px var(--neon),0 0 18px var(--neon); }
    .card { background:var(--card); border:2px solid var(--neon); border-radius:14px;
            padding:16px; margin:18px 0; box-shadow:0 0 16px rgba(0,255,255,.35); }
    button { padding:10px 16px; border-radius:10px; border:2px solid var(--neon);
             background:transparent; color:var(--neon); font-weight:700; cursor:pointer; }
    button:hover { background:var(--neon); color:#102326; box-shadow:0 0 16px var(--neon); }

        button:hover { background:var(--neon); color:#102326; box-shadow:0 0 16px var(--neon); }

    /* extra styles */
    blockquote {
      font-style: italic;
      font-size: 1.1rem;
      margin: 16px 0;
      padding-left: 12px;
      border-left: 3px solid var(--neon);
    }

    #classificationButtons {
      display: flex;
      gap: 10px;
      margin: 16px 0;
    }

    #classificationButtons button {
      flex: 1;
      padding: 10px;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: #fff;
    }

    .strong-anti    { background: #d32f2f; }
    .moderate-anti  { background: #f57c00; }
    .neutral        { background: #757575; }
    .moderate-pro   { background: #81c784; }
    .strong-pro     { background: #388e3c; }

  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- Main Menu -->
  <section id="mainMenu">
    <h1>Welcome to News Ranker</h1>
    <div class="card">
      <p>Select a News Topic to Rank:</p>
      <button onclick="selectTopic('Illegal Immigration')">Illegal Immigration</button>
      <button onclick="selectTopic('Police')">Police</button>
      <button onclick="selectTopic('Universal Healthcare')">Universal Healthcare</button>
    </div>
  </section>

  <!-- Topic Page -->
  <section id="topicPage" style="display:none;">
    <h2 id="topicTitle"></h2>
    <p id="question"></p>
    <blockquote id="headline">"Placeholder headline goes here."</blockquote>

  <div id="classificationButtons">
    <button class="strong-anti"    data-rating="-2">Strongly Anti</button>
    <button class="moderate-anti"  data-rating="-1">Moderately Anti</button>
    <button class="neutral"        data-rating="0">Neutral</button>
    <button class="moderate-pro"   data-rating="1">Moderately Pro</button>
    <button class="strong-pro"     data-rating="2">Strongly Pro</button>
  </div>
  <div id="rateStatus" style="margin-top:8px;color:var(--muted);"></div>


    <div style="margin-top:20px;">
      <button onclick="goHome()">Main Menu</button>
      <button onclick="nextHeadline()">Next Headline</button>

      
    </div>
  </section>


  <script>

    // Supabase connection
    const SUPABASE_URL = 'https://yjgzdeqolyuzuygyvdmz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqZ3pkZXFvbHl1enV5Z3l2ZG16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NjcyMTQsImV4cCI6MjA3NDA0MzIxNH0.8H1t3ThpRtFLavN3tn8lxS89RfQUwvBKE80wzwSKDdY';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentTopicId = null;
    let currentTopicTitle = null;
    let currentHeadline = null;


    // at top of your <script>, after creating `sb`
    let deviceId = localStorage.getItem('nr_device_id');
    if (!deviceId) {
      deviceId = crypto.randomUUID();
      localStorage.setItem('nr_device_id', deviceId);
    }

    
    // Get a random headline for the selected topic
    async function loadRandomHeadlineForTopic(topicTitle) {
      // 1) Topic lookup (cache by title)
      if (currentTopicTitle !== topicTitle) {
        const { data: t, error: tErr } = await sb
          .from('topics')
          .select('id,title')
          .eq('title', topicTitle)
          .single();
        if (tErr) return alert('Topic lookup error: ' + tErr.message);
        currentTopicId = t.id;
        currentTopicTitle = t.title;
      }
    
      // 2) Count headlines for topic
      const { count, error: cErr } = await sb
        .from('headlines')
        .select('id', { count: 'exact', head: true })
        .eq('topic_id', currentTopicId);
      if (cErr) return alert('Count error: ' + cErr.message);
      if (!count) {
        document.getElementById('headline').textContent = `"No headlines yet for ${topicTitle}."`;
        return;
      }
    
      // 3) Pick random offset and fetch one
      const idx = Math.floor(Math.random() * count);
      const { data: rows, error: hErr } = await sb
        .from('headlines')
        .select('id,text')
        .eq('topic_id', currentTopicId)
        .range(idx, idx);
      if (hErr) return alert('Headline fetch error: ' + hErr.message);
      if (!rows?.length) {
        document.getElementById('headline').textContent = `"No headline found."`;
        return;
      }
    
      currentHeadline = rows[0]; // { id, text }
      document.getElementById('headline').textContent = `"${rows[0].text}"`;
    }

  
          

    
    // Make selectTopic async and load a random headline
    async function selectTopic(topic) {
      document.getElementById('mainMenu').style.display = 'none';
      document.getElementById('topicPage').style.display = 'block';
      document.getElementById('topicTitle').textContent = `Topic: ${topic}`;
      document.getElementById('question').innerHTML =
        `Does this headline <b style="font-size:1.3em;">frame</b> ` +
        `<b style="font-size:1.3em; text-decoration:underline;">${topic}</b> ` +
        `as good (PRO), bad (ANTI), or neither (NEUTRAL)?`;
    
      await loadRandomHeadlineForTopic(topic);
    }


    function goHome() {
      document.getElementById('topicPage').style.display = 'none';
      document.getElementById('mainMenu').style.display = 'block';
    }

    // Next Headline button -> fetch another random one
    async function nextHeadline() {
      if (!currentTopicTitle) return;
      await loadRandomHeadlineForTopic(currentTopicTitle);
    }

    // Map numeric buttons → enum labels
    const STANCE_ENUM = {
      [-2]: 'strongly_anti',
      [-1]: 'moderately_anti',
       [0]: 'neutral',
       [1]: 'moderately_pro',
       [2]: 'strongly_pro',
    };
    
      // Listen for clicks on any classification button
      document.getElementById('classificationButtons').addEventListener('click', async (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const val = Number(btn.dataset.rating);
      await handleRating(val);
    });
  
    async function handleRating(val) {
      const statusEl = document.getElementById('rateStatus');
      if (!currentHeadline?.id) { alert('Pick a topic first.'); return; }
    
      const payload = {
        headline_id: currentHeadline.id,
        stance_chosen: STANCE_ENUM[val],
        device_id: deviceId,
        user_id: null
      };
    
      const { data, error } = await sb.from('ratings').insert(payload).select('id').single();
    
      if (error) {
        // 23505 = unique violation (already rated this headline on this device)
        if (error.code === '23505') {
          statusEl.textContent = 'Already rated. Loading next…';
          await nextHeadline();
          return;
        }
        console.error(error);
        statusEl.textContent = 'Save failed: ' + error.message;
        return;
      }
    
      statusEl.textContent = `Saved (id: ${data.id})`;
      // optional: auto-advance after save
      // setTimeout(nextHeadline, 300);
    }


  </script>
</body>

</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Headline Game</title>
  <style>
    :root { --neon:#0ff; --bg:#111; --card:#1b1b1b; --text:#eee; --muted:#aaa; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, Arial, sans-serif; background:var(--bg); color:var(--text);
           max-width:720px; margin:2rem auto; padding:0 1rem; }
    h1 { text-align:center; color:var(--neon); text-shadow:0 0 8px var(--neon),0 0 18px var(--neon); }
    .card { background:var(--card); border:2px solid var(--neon); border-radius:14px;
            padding:16px; margin:18px 0; box-shadow:0 0 16px rgba(0,255,255,.35); }
    button { padding:10px 16px; border-radius:10px; border:2px solid var(--neon);
             background:transparent; color:var(--neon); font-weight:700; cursor:pointer; }
    button:hover { background:var(--neon); color:#102326; box-shadow:0 0 16px var(--neon); }

        button:hover { background:var(--neon); color:#102326; box-shadow:0 0 16px var(--neon); }

    /* extra styles */
    blockquote {
      font-style: italic;
      font-size: 1.1rem;
      margin: 16px 0;
      padding-left: 12px;
      border-left: 3px solid var(--neon);
    }

    #classificationButtons {
      display: flex;
      gap: 10px;
      margin: 16px 0;
    }

    #classificationButtons button {
      flex: 1;
      padding: 10px;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: #fff;
    }

    .strong-anti    { background: #d32f2f; }
    .moderate-anti  { background: #f57c00; }
    .neutral        { background: #757575; }
    .moderate-pro   { background: #81c784; }
    .strong-pro     { background: #388e3c; }

   /* This is for the results box styling. */

    /* === Poll results bars === */
    .results-row { margin: 8px 0; }
    .results-label {
      display:block;
      margin-bottom:4px;
      color: var(--muted);
      font-size: 0.95rem;
    }
    .results-bar {
      position: relative;
      height: 26px;
      border-radius: 6px;
      background: #111;       /* dark track */
      border: 1px solid #333; /* subtle outline */
      overflow: hidden;
    }
    .results-fill {
      position:absolute;
      top:0; left:0;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:flex-end;
      padding-right:8px;
      font-weight:700;
      color:#111; /* dark text against neon */
      text-shadow: 0 0 6px var(--neon), 0 0 12px var(--neon);
      background: var(--neon);
      box-shadow: 0 0 12px var(--neon), inset 0 0 8px rgba(0,255,255,.6);
      transition: width .6s ease-out;
    }

      @media (prefers-reduced-motion: reduce) {
      .results-fill { transition: none; }
    }

    /* Top Banner Style*/
      .top-banner{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:10px 14px; margin:0 0 14px 0;
      border-radius:12px; border:1px solid rgba(0,255,255,.4);
      background: linear-gradient(135deg, rgba(0,255,255,.08), rgba(0,255,255,.02));
      box-shadow: 0 0 12px rgba(0,255,255,.18), inset 0 0 10px rgba(0,255,255,.08);
    }
    .banner-actions{ display:flex; gap:10px; }
    .banner-btn{
      padding:8px 12px; border-radius:10px; font-weight:700; cursor:pointer;
      border:1px solid var(--neon); color:var(--neon); background:transparent;
    }
    .banner-btn:hover{ background:var(--neon); color:#102326; box-shadow:0 0 12px var(--neon); }


    #headline {
      margin: 16px 0;  /* top & bottom spacing */
      font-size: 1.1rem;
      line-height: 1.4;
    }

    
    
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

<!-- Top Banner -->
  <div id="topBanner" class="top-banner">
  <span id="activeUser">Signed in as —</span>
  <div class="banner-actions">
    <button id="gameInfoBtn" class="banner-btn">Game Info</button>
    <button id="changeUserBtn" class="banner-btn">Change User</button>
  </div>
</div>

  <!-- User Name Unique -->
  <section id="usernameGate" class="card" style="display:block;>
  <h2>Enter a Username to Start</h2>
  <div style="display:flex; gap:8px; align-items:center;">
    <input id="usernameInput" type="text" placeholder="Choose a unique username" style="flex:1;">
    <button id="usernameBtn">Continue</button>
  </div>
  <div id="usernameMsg" style="margin-top:8px; color:var(--muted);"></div>
</section>

  <!-- Main Menu -->
  <section id="mainMenu" style="display:none;">
   
    <h1>Welcome to News Ranker</h1>
    <p>Select a News Topic to Rank:</p>
    <button onclick="selectTopic('Illegal Immigration')">Illegal Immigration</button>
    <button onclick="selectTopic('Police')">Police</button>
    <button onclick="selectTopic('Universal Healthcare')">Universal Healthcare</button>
  

  </section>
  

  <!-- Topic Page -->
  <section id="topicPage" style="display:none;">
    <h2 id="topicTitle"></h2>
    <p id="question" style="display:none;"></p>
    <blockquote id="headline">"Placeholder  goes here."</blockquote>

  <div id="classificationButtons">
    <button class="strong-anti"    data-rating="-2">Strongly Anti</button>
    <button class="moderate-anti"  data-rating="-1">Moderately Anti</button>
    <button class="neutral"        data-rating="0">Neutral</button>
    <button class="moderate-pro"   data-rating="1">Moderately Pro</button>
    <button class="strong-pro"     data-rating="2">Strongly Pro</button>
  </div>
  <div id="rateStatus" style="margin-top:8px;color:var(--muted);"></div>

 <!-- Results box -->
  <div id="results" class="card" style="display:none; margin-top:16px;">
    <h3>This is How Other People Ranked this </h3>
    <div id="resultsList"></div>
  </div>
    
    <div style="margin-top:20px;">
      <button onclick="goHome()">Main Menu</button>
      <button onclick="nextHeadline()">Next Headline</button>

      
    </div>
  </section>


  <script>

    // This is about user ID
    let currentPlayerId = localStorage.getItem('nr_player_id');
    let currentUsername = localStorage.getItem('nr_username');

    document.addEventListener('DOMContentLoaded', async () => {
      if (currentPlayerId && currentUsername) {
        document.getElementById('usernameGate').style.display = 'none';
        document.getElementById('mainMenu').style.display = 'block';
      } else {
        document.getElementById('usernameGate').style.display = 'block';
        document.getElementById('mainMenu').style.display = 'none';
      }
      updateActiveUserLabel();
    });

    document.getElementById('changeUserBtn').addEventListener('click', () => {
      // clear local user info
      localStorage.removeItem('nr_player_id');
      localStorage.removeItem('nr_username');
      currentPlayerId = null;
      currentUsername = null;

      updateActiveUserLabel();
    
      // switch screens
      document.getElementById('mainMenu').style.display = 'none';
      document.getElementById('usernameGate').style.display = 'block';
    });
    

      // Game Info (simple placeholder; swap for a modal later)
      document.getElementById('gameInfoBtn').addEventListener('click', () => {
        alert(
          'News Ranker: Pick a topic, read a headline, and classify the framing. ' +
          'Your vote updates the live poll. Change User to test as different players.'
        );
      });
      
      // Change User (keep or replace your existing handler with this)
      document.getElementById('changeUserBtn').addEventListener('click', () => {
        localStorage.removeItem('nr_player_id');
        localStorage.removeItem('nr_username');
        currentPlayerId = null;
        currentUsername = null;
        updateActiveUserLabel();
        document.getElementById('mainMenu').style.display = 'none';
        document.getElementById('usernameGate').style.display = 'block';
      });
      
      
    

    // All this is about getting the user to enter thier ID
    document.getElementById('usernameBtn').addEventListener('click', async () => {
      const msg = document.getElementById('usernameMsg');
      const raw = document.getElementById('usernameInput').value.trim();
      const uname = raw.replace(/\s+/g, '_');
      if (!uname) { msg.textContent = 'Please enter a username.'; return; }
    
      // 1) Try to create the user
      const { data: created, error } = await sb
        .from('players')
        .insert({ username: uname, actor_id: crypto.randomUUID() })
        .select('actor_id,username')
        .single();
    
      if (error) {
        // 23505 = unique violation → username already exists → fetch it
        if (error.code === '23505') {
          const { data: existing, error: fetchErr } = await sb
            .from('players')
            .select('actor_id,username')
            .ilike('username', uname)  // case-insensitive exact match (unique index guarantees 1 row)
            .single();
    
          if (fetchErr) { msg.textContent = 'Error: ' + fetchErr.message; return; }
    
          currentPlayerId = existing.actor_id;
          currentUsername = existing.username;
        } else {
          msg.textContent = 'Error: ' + error.message;
          return;
        }
      } else {
        currentPlayerId = created.actor_id;
        currentUsername = created.username;
      }
    
      localStorage.setItem('nr_player_id', currentPlayerId);
      localStorage.setItem('nr_username', currentUsername);
      updateActiveUserLabel();
      document.getElementById('usernameGate').style.display = 'none';
      document.getElementById('mainMenu').style.display = 'block';
    });

    
        
    
    // Supabase connection
    const SUPABASE_URL = 'https://yjgzdeqolyuzuygyvdmz.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlqZ3pkZXFvbHl1enV5Z3l2ZG16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg0NjcyMTQsImV4cCI6MjA3NDA0MzIxNH0.8H1t3ThpRtFLavN3tn8lxS89RfQUwvBKE80wzwSKDdY';
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    
  // --- App state ---
  let currentTopicId = null;
  let currentTopicTitle = null;
  let currentHeadline = null;

  // Stable device id (no auth yet)
  let deviceId = localStorage.getItem('nr_device_id');
  if (!deviceId) {
    deviceId = crypto.randomUUID();
    localStorage.setItem('nr_device_id', deviceId);
  }

  // --- Data helpers ---
  async function loadRandomHeadlineForTopic(topicTitle) {
    // (1) Topic lookup (cache)
    if (currentTopicTitle !== topicTitle) {
      const { data: t, error: tErr } = await sb
        .from('topics')
        .select('id,title')
        .eq('title', topicTitle)
        .single();
      if (tErr) { alert('Topic lookup error: ' + tErr.message); return; }
      currentTopicId = t.id;
      currentTopicTitle = t.title;
    }

    // (2) Count headlines
    const { count, error: cErr } = await sb
      .from('headlines')
      .select('id', { count: 'exact', head: true })
      .eq('topic_id', currentTopicId);
    if (cErr) { alert('Count error: ' + cErr.message); return; }
    if (!count) {
      document.getElementById('headline').textContent = `"No headlines yet for ${topicTitle}."`;
      return;
    }

    // (3) Random fetch
    const idx = Math.floor(Math.random() * count);
    const { data: rows, error: hErr } = await sb
      .from('headlines')
      .select('id,text')
      .eq('topic_id', currentTopicId)
      .range(idx, idx);
    if (hErr) { alert('Headline fetch error: ' + hErr.message); return; }
    if (!rows?.length) {
      document.getElementById('headline').textContent = `"No headline found."`;
      return;
    }

    currentHeadline = rows[0];
    document.getElementById('headline').textContent = `"${rows[0].text}"`;
  }

  function updateActiveUserLabel() {
    const el = document.getElementById('activeUser');
    el.textContent = currentUsername ? `Signed in as ${currentUsername}` : 'Signed in as —';
  }


  // --- UI actions ---
  async function selectTopic(topic) {
    document.getElementById('mainMenu').style.display = 'none';
    document.getElementById('topicPage').style.display = 'block';
    document.getElementById('topicTitle').textContent = `Topic: ${topic}`;
  
    // Add const q and also unhide it
    const q = document.getElementById('question');
    q.innerHTML = `Does this headline <b style="font-size:1.3em;">frame</b>
      <b style="font-size:1.3em; text-decoration:underline;">${topic}</b>
      as good (PRO), bad (ANTI), or neither (NEUTRAL)?`;
    q.style.display = 'block';

  
    document.getElementById('rateStatus').textContent = '';
    document.getElementById('results').style.display = 'none';
    await loadRandomHeadlineForTopic(topic);
  }


  function goHome() {
    document.getElementById('topicPage').style.display = 'none';
    document.getElementById('mainMenu').style.display = 'block';
  }

  async function nextHeadline() {
    if (!currentTopicTitle) return;
    document.getElementById('rateStatus').textContent = '';
    document.getElementById('results').style.display = 'none';
    await loadRandomHeadlineForTopic(currentTopicTitle);
  }

  // --- Ratings wiring ---
  const STANCE_ENUM = {
    [-2]: 'strongly_anti',
    [-1]: 'moderately_anti',
     [0]: 'neutral',
     [1]: 'moderately_pro',
     [2]: 'strongly_pro',
  };

  document.getElementById('classificationButtons').addEventListener('click', async (e) => {
    const btn = e.target.closest('button');
    if (!btn) return;
    const val = Number(btn.dataset.rating);
    await handleRating(val);
  });

  async function handleRating(val) {
    const statusEl = document.getElementById('rateStatus');
    if (!currentHeadline?.id) { alert('Pick a topic first.'); return; }

     const payload = {
      headline_id: currentHeadline.id,
      stance_chosen: STANCE_ENUM[val],
      device_id: deviceId,
      user_id: currentPlayerId || null,   // store actor_id here
      };



    const { data, error } = await sb
      .from('ratings')
      .insert(payload)
      .select('id')
      .single();

    if (error) {
      // 23505 unique violation (if you later add unique index)
      if (error.code === '23505') {
        statusEl.textContent = 'Already rated. Showing results…';
      } else {
        console.error(error);
        statusEl.textContent = 'Save failed: ' + error.message;
        return;
      }
    } else {
      statusEl.textContent = `Your vote has been recorded!`;
    }

    await showResultsForCurrentHeadline();
  }

  // --- Results (neon bars) ---
  async function showResultsForCurrentHeadline() {
    if (!currentHeadline?.id) return;

    const { data, error } = await sb
      .from('ratings')
      .select('stance_chosen')
      .eq('headline_id', currentHeadline.id);

    const box = document.getElementById('results');
    const list = document.getElementById('resultsList');

    if (error) {
      list.textContent = 'Error loading results.';
      box.style.display = 'block';
      return;
    }

    const counts = { strongly_anti:0, moderately_anti:0, neutral:0, moderately_pro:0, strongly_pro:0 };
    data.forEach(r => { counts[r.stance_chosen] = (counts[r.stance_chosen] ?? 0) + 1; });
    const total = data.length || 1;

    const order = [
      ['strongly_anti','Strongly Anti'],
      ['moderately_anti','Moderately Anti'],
      ['neutral','Neutral'],
      ['moderately_pro','Moderately Pro'],
      ['strongly_pro','Strongly Pro']
    ];

    // Build bars (render at 0% first, then animate)
    const html = order.map(([key, label]) => {
      const pct = Math.round((counts[key] * 100) / total);
      const fill = pct > 0
        ? `<div class="results-fill" data-target="${pct}" style="width:0%;">${pct}%</div>`
        : ``;
      return `
        <div class="results-row">
          <span class="results-label">${label}</span>
          <div class="results-bar">
            ${fill}
          </div>
        </div>
      `;
    }).join('');
    
    list.innerHTML = html;
    box.style.display = 'block';
    
    // Kick off the animation
    requestAnimationFrame(() => {
      document.querySelectorAll('#results .results-fill').forEach(el => {
        const pct = el.getAttribute('data-target');
        el.style.width = pct + '%';
      });
    });
  }
</script>
</body>

</html>
